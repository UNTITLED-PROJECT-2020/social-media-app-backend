<!-- chat/templates/chat/group/testing/room.html -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Test Group</title>
</head>

<body>
    <textarea id="chat-log" cols="100" rows="20"></textarea>
    <span style="display: inline-block;">
            <p style="width: fit-content;margin: 0">is typing ??</p>
            <textarea id="is-typing-log" cols="25" rows="2"></textarea>
            <input id="is-typing-submit" type="button" value="Send">
    </span>
    <br>
    <input id="chat-message-input" type="text" size="100"><br>
    <input id="chat-message-submit" type="button" value="Send"><br><br>

    <br>
    <h1>this chat is for contact : {{msg_from}}</h1>
    <h1>this chat is for group : {{grp}}</h1>

    <hr>

    <br><br>
    <h3>Time-Based Functions</h3>

    <br>
    <h4>msg_received box</h4>
    <textarea id="received-log" cols="60" rows="2"></textarea><br>
    <input id="received-input" type="text" size="100">
    <input id="chat-message-received" type="button" value="Send 'msg_received' command"><br><br>

    <br>
    <h4>msg_read box</h4>
    <textarea id="seen-log" cols="60" rows="2"></textarea><br>
    <input id="seen-input" type="text" size="100">
    <input id="chat-message-seen" type="button" value="Send 'msg_read' command"><br><br>

    {{ msg_from | json_script:"msg_from" }}
    {{ grp | json_script:"grp" }}

    <hr>
    
    <br><br>
    <h3>Special Functions</h3>

    <br>
    <h4>fetch_msgs box</h4>
    <textarea id="fetch-msgs-log" cols="100" rows="20"></textarea><br>
    <input id="fetch-msgs-btn" type="button" value="Send 'fetch_msgs' command"><br><br>

    <br>
    <h4>fetch_grp_msgs box</h4>
    <textarea id="fetch-grp-msgs-log" cols="100" rows="20"></textarea><br>
    <input id="fetch-grp-msgs-btn" type="button" value="Send 'fetch_grp_msgs' command"><br><br>

    <script>

        function addZero(x, n) {
                    while (x.toString().length < n) {
                        x = "0" + x;
                    }
                    return x;
                }

        function getTimestamp(){
            var currentdate = new Date();
            var datetime = currentdate.getFullYear() + "-" +
                    addZero(currentdate.getMonth() + 1, 2) + "-" +
                    addZero(currentdate.getDate(), 2) + " " +
                    addZero(currentdate.getHours(), 2) + ":" +
                    addZero(currentdate.getMinutes(), 2) + ":" +
                    addZero(currentdate.getSeconds(), 2) + "." +
                    currentdate.getMilliseconds();
            
            return datetime;
        }

        const msg_from = JSON.parse(document.getElementById('msg_from').textContent);
        const grp = JSON.parse(document.getElementById('grp').textContent);

        console.log(`msg_from : ${msg_from}, group : ${grp}`);

        const chatReceiveSocket = new WebSocket(
            'ws://' +
            window.location.host +
            '/ws/chat/special/' +
            msg_from + '/'
        );

        const chatSendSocket = new WebSocket(
            'ws://' +
            window.location.host +
            '/ws/chat/group/' +
            msg_from + '/' + grp + '/'
        );

        //==================//
        // Websocket Functions
        //==================//

        chatReceiveSocket.onopen = function (e) {
            console.log(`chat socket opened at ${chatReceiveSocket.url}`);
        }

        chatReceiveSocket.onerror = function (e) {
            console.log("error occured : ");
            console.log(e);
        }

        chatReceiveSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);

            // put condition for type of data received on data.command
            if (data['command'] == 'new_msg') {
                console.log(`"new_msg" received, responce : ${e.data}`);

                if(data.msg_from.length > 10){
                    document.querySelector('#chat-log').value += ('\t\t' + data.message + ` [from: ${(data.msg_from).split("-")[1]}]` +
                    '\n' + `\t\t\t   [received at : ${data['sent_timestamp']}]\n\n`);
                } else {
                    document.querySelector('#chat-log').value += ('\t\t' + data.message + ` [from: ${data.msg_from}]` +
                    '\n' + `\t\t\t   [received at : ${data['sent_timestamp']}]\n\n`);
                }

            } else if (data['command'] == 'msg_read') {
                document.querySelector('#seen-log').value = (`last message seen at ${data['sent_timestamp']}`);
            } else if (data['command'] == 'msg_received'){
                console.log(data)
                document.querySelector('#received-log').value = (`last message received at ${data['sent_timestamp']}`);
            } else if (data['command'] == 'fetch_msgs'){
                console.log(data['messages']);
                document.querySelector('#fetch-msgs-log').value = (JSON.stringify(JSON.parse(data['messages']), null, 1));
            } else if (data['command'] == 'fetch_grp_msgs'){
                console.log(data['messages']);
                document.querySelector('#fetch-grp-msgs-log').value = (JSON.stringify(JSON.parse(data['messages']), null, 1));
            } else if (data['command'] == 'delete_msg'){
                document.querySelector('#delete-msg-log').value = ("Message Deleted");
            } else if (data['command'] == 'delete_msgs'){
                document.querySelector('#delete-msgs-log').value = ("Messages Deleted");
            } else if (data['command'] == 'is_typing'){

                if(data.msg_from.length > 10){
                    document.querySelector('#is-typing-log').value = (data.msg_from.split("-")[1] + " is typing...");
                } else {
                    document.querySelector('#is-typing-log').value = (data.msg_from + " is typing...");
                }

            } else if (data['command'] == 'error'){
                if (data['type'] == 'fetch_msgs'){
                    console.error(data['message']);
                } else if (data['type'] == 'delete_msg'){
                    console.error(data['message']);
                } else if (data['type'] == 'delete_msgs'){
                    console.error(data['message']);
                }
            }
        };

        chatReceiveSocket.onclose = function (e) {
            console.error('Chat socket closed unexpectedly');
        };

        //==================//
        // Dialog Box Functions
        //==================//

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function (e) {
            if (e.keyCode === 13) { // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function (e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;

            // sending data
            chatSendSocket.send(JSON.stringify({
                'message': message,
                'command': 'new_grp_msg',
                'msg_from': msg_from,
                'msg_to': grp,
                'sent_timestamp': getTimestamp(),
            }));

            chatSendSocket.onmessage = function (e) {
                if (JSON.parse(e.data)['command'] == "msg_sent") {
                    document.querySelector('#chat-log').value += (
                        `   [sent at : ${JSON.parse(e.data)['message']}]\n\n`);
                } else {
                    console.log(`msg responce : \n ${e.data}`);
                    console.log(e);
                }

            }

            document.querySelector('#chat-log').value += (message + '\n');

            messageInputDom.value = '';
        };


        // send message to other user that user is typing
        document.querySelector('#is-typing-submit').onclick = function (e) {
            // sending data
            chatSendSocket.send(JSON.stringify({
                'message': "-null-",
                'command': 'is_grp_typing',
                'msg_from': msg_from,
                'msg_to': grp,
                'sent_timestamp': getTimestamp(),
            }));
        }

        // send message to other user that message was received
        document.querySelector('#chat-message-received').onclick = function (e) {
            var timestamp = document.querySelector('#received-input').value;
            // sending data
            chatSendSocket.send(JSON.stringify({
                'message': timestamp,
                'command': 'grp_msg_received',
                'msg_from': msg_from,
                'msg_to': grp,
                'sent_timestamp': getTimestamp(),
            }));
        }

        // send message to other user that message was seen
        document.querySelector('#chat-message-seen').onclick = function (e) {
            var timestamp = document.querySelector('#seen-input').value;
            // sending data
            chatSendSocket.send(JSON.stringify({
                'message': timestamp,
                'command': 'grp_msg_read',
                'msg_from': msg_from,
                'msg_to': grp,
                'sent_timestamp': getTimestamp(),
            }));
        }

        // fetch unread messages
        document.querySelector('#fetch-msgs-btn').onclick = function (e) {
            // sending data (interchange for correctness)
            chatReceiveSocket.send(JSON.stringify({
                'message': 'none',
                'command': 'fetch_msgs',
                'msg_from': grp,
                'msg_to': msg_from,
                'sent_timestamp': getTimestamp(),
            }));
        }

        // fetch unread group messages
        document.querySelector('#fetch-grp-msgs-btn').onclick = function (e) {
            // sending data (interchange for correctness)
            chatReceiveSocket.send(JSON.stringify({
                'message': '--null--',
                'command': 'fetch_grp_msgs',
                'msg_from': grp,
                'msg_to': msg_from,
                'sent_timestamp': getTimestamp(),
            }));
        }
    </script>
</body>

</html>