<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Test Chat Room</title>
</head>

<body>
    <textarea id="chat-log" cols="100" rows="20"></textarea><br>
    <input id="chat-message-input" type="text" size="100"><br>
    <input id="chat-message-submit" type="button" value="Send"><br><br>

    <br>
    <h1>this chat is for contact : {{msg_from}}</h1>

    <hr>

    <br><br>
    <h3>Time-Based Functions</h3>

    <br>
    <h4>msg_received box</h4>
    <textarea id="received-log" cols="60" rows="2"></textarea><br>
    <input id="chat-message-received" type="button" value="Send 'msg_received' command"><br><br>

    <br>
    <h4>msg_read box</h4>
    <textarea id="seen-log" cols="60" rows="2"></textarea><br>
    <input id="chat-message-seen" type="button" value="Send 'msg_read' command"><br><br>

    {{ msg_from | json_script:"msg_from" }}
    {{ msg_to | json_script:"msg_to" }}

    <hr>
    
    <br><br>
    <h3>Special Functions</h3>

    <br>
    <h4>fetch_msgs box</h4>
    <textarea id="fetch-msgs-log" cols="100" rows="20"></textarea><br>
    <input id="fetch-msgs-btn" type="button" value="Send 'fetch_msgs' command"><br><br>

    <br>
    <h4>delete_msg box</h4>
    <textarea id="delete-msg-log" cols="60" rows="2"></textarea><br>
    <input id="delete-msg-input" type="text" size="100">
    <input id="delete-msg-btn" type="button" value="Send 'delete_msg' command"><br><br>

    <br>
    <h4>delete_msgs box</h4>
    <textarea id="delete-msgs-log" cols="60" rows="2"></textarea><br>
    <input id="delete-msgs-input" type="text" size="100">
    <input id="delete-msgs-btn" type="button" value="Send 'delete_msgs' command"><br><br>

    <script>

        function addZero(x, n) {
                    while (x.toString().length < n) {
                        x = "0" + x;
                    }
                    return x;
                }

        function getTimestamp(){
            var currentdate = new Date();
            var datetime = currentdate.getFullYear() + "-" +
                    addZero(currentdate.getMonth() + 1, 2) + "-" +
                    addZero(currentdate.getDate(), 2) + " " +
                    addZero(currentdate.getHours(), 2) + ":" +
                    addZero(currentdate.getMinutes(), 2) + ":" +
                    addZero(currentdate.getSeconds(), 2) + "." +
                    currentdate.getMilliseconds();
            
            return datetime;
        }

        const msg_from = JSON.parse(document.getElementById('msg_from').textContent);
        const msg_to = JSON.parse(document.getElementById('msg_to').textContent);

        console.log(`msg_from : ${msg_from}, msg_to : ${msg_to}`);
        console.log(`current location : ${window.location.host}`);

        const chatReceiveSocket = new WebSocket(
            'wss://' +
            window.location.host +
            '/ws/chat/special/' +
            msg_from + '/'
        );

        const chatSendSocket = new WebSocket(
            'wss://' +
            window.location.host +
            '/ws/chat/personal/' +
            msg_from + '/' + msg_to + '/'
        );

        //==================//
        // Websocket Functions
        //==================//

        chatReceiveSocket.onopen = function (e) {
            console.log(`chat socket opened at ${chatReceiveSocket.url}`);
        }

        chatReceiveSocket.onerror = function (e) {
            console.log("error occured : ");
            console.log(e);
        }

        chatReceiveSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);

            // put condition for type of data received on data.command
            if (data['command'] == 'new_msg') {
                console.log(`"new_msg" received, responce : ${e.data}`);
                document.querySelector('#chat-log').value += ('\t\t' + data.message + ` [from: ${data.msg_from}]` +
                    '\n' + `\t\t\t   [received at : ${data['sent_timestamp']}]\n\n`);

                // sending 'seen' responce
                chatSendSocket.send(JSON.stringify({
                    'message': data['sent_timestamp'],
                    'msg_from': msg_from,
                    'msg_to': msg_to,
                    'command': 'msg_received',
                    'sent_timestamp': getTimestamp(),
                }));

            } else if (data['command'] == 'msg_read') {
                document.querySelector('#seen-log').value = (`last message seen at ${data['sent_timestamp']}`);
            } else if (data['command'] == 'msg_received'){
                document.querySelector('#received-log').value = (`last message received at ${data['sent_timestamp']}`);
            } else if (data['command'] == 'fetch_msgs'){
                document.querySelector('#fetch-msgs-log').value = (JSON.stringify(JSON.parse(data['messages']), null, 1));
            } else if (data['command'] == 'delete_msg'){
                document.querySelector('#delete-msg-log').value = ("Message Deleted");
            } else if (data['command'] == 'delete_msgs'){
                document.querySelector('#delete-msgs-log').value = ("Messages Deleted");
            } else if (data['command'] == 'error'){
                if (data['type'] == 'fetch_msgs'){
                    console.error(data['message']);
                } else if (data['type'] == 'delete_msg'){
                    console.error(data['message']);
                } else if (data['type'] == 'delete_msgs'){
                    console.error(data['message']);
                }
            }
        };

        chatReceiveSocket.onclose = function (e) {
            console.error('Chat socket closed unexpectedly');
        };

        //==================//
        // Dialog Box Functions
        //==================//

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function (e) {
            if (e.keyCode === 13) { // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function (e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;


            // sending data
            chatSendSocket.send(JSON.stringify({
                'message': message,
                'command': 'new_msg',
                'msg_from': msg_from,
                'msg_to': msg_to,
                'sent_timestamp': getTimestamp(),
            }));

            chatSendSocket.onmessage = function (e) {
                if (JSON.parse(e.data)['command'] == "msg_sent") {
                    document.querySelector('#chat-log').value += (
                        `   [sent at : ${JSON.parse(e.data)['sent_timestamp']}]\n\n`);
                } else {
                    console.log(`msg responce : \n ${e.data}`);
                    console.log(e);
                }

            }

            document.querySelector('#chat-log').value += (message + '\n');

            messageInputDom.value = '';
        };



        // send message to other user that message was received
        document.querySelector('#chat-message-received').onclick = function (e) {
            // sending data
            chatSendSocket.send(JSON.stringify({
                'message': 'none',
                'command': 'msg_received',
                'msg_from': msg_from,
                'msg_to': msg_to,
                'sent_timestamp': getTimestamp(),
            }));
        }

        // send message to other user that message was seen
        document.querySelector('#chat-message-seen').onclick = function (e) {
            // sending data
            chatSendSocket.send(JSON.stringify({
                'message': 'none',
                'command': 'msg_read',
                'msg_from': msg_from,
                'msg_to': msg_to,
                'sent_timestamp': getTimestamp(),
            }));
        }

        // fetch unread messages
        document.querySelector('#fetch-msgs-btn').onclick = function (e) {
            // sending data (interchange for correctness)
            chatReceiveSocket.send(JSON.stringify({
                'message': 'none',
                'command': 'fetch_msgs',
                'msg_from': msg_to,
                'msg_to': msg_from,
                'sent_timestamp': getTimestamp(),
            }));
        }

        // delete single message
        document.querySelector('#delete-msg-btn').onclick = function (e) {
            // time stamp variable
            var timestamp = document.querySelector('#delete-msg-input').value;

            if(timestamp.length != 0){
                // sending data
                chatReceiveSocket.send(JSON.stringify({
                    'message': timestamp,
                    'command': 'delete_msg',
                    'msg_from': msg_to,
                    'msg_to': msg_from,
                    'sent_timestamp': getTimestamp(),
                }));
            } else {
                console.error("'delete_msg' timestamp absent");
            }
            
        }

        // delete multiple messages
        document.querySelector('#delete-msgs-btn').onclick = function (e) {
            // time stamp variable
            var timestamp = document.querySelector('#delete-msgs-input').value;

            if(timestamp.length != 0){
                // sending data
                chatReceiveSocket.send(JSON.stringify({
                    'message': timestamp,
                    'command': 'delete_msgs',
                    'msg_from': msg_to,
                    'msg_to': msg_from,
                    'sent_timestamp': getTimestamp(),
                }));
            } else {
                console.error("'delete_msgs' timestamp absent");
            }
        }
    </script>
</body>

</html>